<p>The Sunbird application consists of multiple services, each service serves a specific purpose. All services except Keycloak are set up using Docker.</p>

<p>The following steps will install docker, pull the required images and create services based on those images.</p>

<h2 id="preparation-to-setup-application">Preparation to Setup Application</h2>

<ul>
  <li>SSH into the application server. If you have used automated scripts as described in the previous steps, then this server would be vm-1</li>
  <li>Clone the Sunbird-devops repo using <code>git clone https://github.com/project-sunbird/sunbird-devops.git</code></li>
  <li>Copy over the generated configuration directory from the database server<code>{implementation-name}-devops</code> to your machine</li>
  <li>Modify all the configurations under <strong>APPLICATION CONFIGURATION</strong> block.</li>
  <li>The automated setup also creates a proxy server and like all proxy servers, it requires an SSL certificate. Ensure that you have a certificate and the key for the domain that you wish to use.</li>
  <li>Run <code>cd sunbird-devops/deploy &amp;&amp; sudo ./install-deps.sh</code> to install the dependencies.</li>
</ul>

<h2 id="api-manager-services">API Manager services</h2>

<ul>
  <li>Run <code>sudo ./deploy-apis.sh {implementation-name}-devops/ansible/inventories/{environment-name}</code>.This will set up the API Manager services.</li>
</ul>

<p><strong>Note:</strong> The following steps are necessary only when the application is being deployed for the first time and should be skipped for subsequent deploys.</p>

<ul>
  <li><code>deploy-apis.sh</code> script will print a JWT token that should be updated in the application configuration</li>
  <li>To find the token search the script output and look for JWT token for player</li>
  <li>Copy the corresponding token</li>
  <li>For reference check the example output as follows:</li>
</ul>

<pre>
changed: [localhost] =&gt; {"changed": true, "cmd": "python /tmp/kong-api-scripts/kong_consumers.py /tmp/kong_consumers.json....
"JWT token for player is :                            
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJlMzU3YWZlOTRmMjA0YjQxODZjNzNmYzQyMTZmZDExZSJ9.
L1nIxwur1a6xVmoJZT7Yc0Ywzlo4vpBVmrdWhJaZro", "Updating rate_limit for consumer player for API cr......"]}
</pre>

<ul>
  <li>
    <p>Update <code>sunbird_api_auth_token</code> in your configuration with the copied token</p>
  </li>
  <li>
    <p>Update <code>sunbird_ekstep_api_key</code> in your configuration with the API token obtained from Ekstep portal</p>
  </li>
</ul>

<p>For API keys you can refer <a href="developer-docs/installation/medium_scale_deploy#api-keys" target="_blank">here</a></p>

<h2 id="proxy-services">Proxy services</h2>

<ul>
  <li>
    <p>To deploy the Sunbird proxy services, execute the following command:</p>

    <p>Run <code>sudo ./deploy-proxy.sh {implementation-name}-devops/ansible/inventories/{environment-name}</code></p>
  </li>
</ul>

<h2 id="provisioning-keycloak">Provisioning Keycloak</h2>

<p><strong>Note:</strong> Sunbird uses Keycloak as the identity and authentication provider.</p>

<p>The Keycloak is deployed on a virtual machine (VM), and you can deploy the Keycloak by following steps:</p>

<ol>
  <li>Run the following script to create the Keycloak username, group name and also to enable Keycloak services on VM</li>
</ol>

<pre>
  ./provision-keycloak.sh {implementation-name}-devops/ansible/inventories/{environment-name}
  </pre>
<ol>
  <li>Update the following variables in the configuration path</li>
</ol>
<pre>
  {implementation-name}-devops/ansible/inventories/{environment-name}/group_vars/{environment-name} // path 
  keycloak_password: (with admin initial password)  //variable to set
  keycloak_theme_path: ex- path/to/the/nile/themes  //variable to set
  sudo ./deploy-keycloak-vm.sh {implementation-name}-devops/ansible/inventories/{environment-name} //command to execute
  </pre>
<p><strong>Note:</strong> The sample themes directory of sunbird is <a href="https://github.com/project-sunbird/sunbird-devops/tree/master/ansible/artifacts" target="_blank">here</a></p>

<ol>
  <li>Follow the instructions <a href="developer-docs/installation/keycloak_realm_configuration">here</a> to setup auth realm in Keycloak</li>
</ol>

<p><strong>Update following configuration</strong></p>

<ul>
  <li>Log in to the <strong>Keycloak admin</strong> console</li>
  <li>Navigate to the clients(admin-cli) Installation</li>
  <li>Select json format</li>
</ul>

<pre>
sunbird_sso_client_id: # Eg: admin-cli
sunbird_sso_username: # keycloak user name
sunbird_sso_password: # keycloak user password
</pre>

<ul>
  <li>Log in to the <strong>Keycloak admin</strong> console</li>
  <li>Navigate to the clients (portal) Installation</li>
  <li>Select json format</li>
</ul>

<pre>
keycloak_realm:  # Eg: Sunbird
sunbird_keycloak_client_id: # Eg: portal
</pre>

<ul>
  <li>Log in to the <strong>Keycloak admin</strong> console</li>
  <li>Navigate to the clients (trampoline) Installation</li>
  <li>Select json format</li>
</ul>

<pre>
sunbird_trampoline_client_id:  # Eg: trampoline
sunbird_trampoline_secret:     # Eg: HJKDHJEHbdggh23737
</pre>

<p>Ensure updating the the following configurations:</p>

<ul>
  <li>Environment Configuration</li>
  <li>Application Server Configuration</li>
  <li>Advanced Configuration</li>
</ul>

<h2 id="core-services">Core services</h2>

<ul>
  <li>
    <p>To deploy the Sunbird core services, execute the following command:</p>

    <p>Run <code>sudo ./deploy-core.sh {implementation-name}-devops/ansible/inventories/{environment-name}</code></p>
  </li>
</ul>

