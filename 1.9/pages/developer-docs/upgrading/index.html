<h2 id="overview">Overview</h2>

<p>Upgrading to the latest version of Sunbird allows you to avail benefits of new and enhanced features and bugs fixed on the platform as well the latest updated versions of any third party component used by it.</p>

<ul>
  <li>From release-1.5:
    <ul>
      <li>All the services are maintained with same image gold  version</li>
      <li>Cassandra migration is introduced to update  cassandra database schema.</li>
    </ul>
  </li>
</ul>

<h2 id="upgrading-sunbird-services">Upgrading Sunbird Services</h2>

<ol>
  <li>
    <p>Pull the latest code of <code>project-sunbird/sunbird-devops</code> from the master branch.</p>
  </li>
  <li>
    <p>It is good practice to take a full backup of all the databases before updating the new schema. Follow steps <a href="developer-docs/installation/medium_scale_deploy/#taking-a-back-up-of-database-servers">here</a> to take backup.</p>
  </li>
  <li>
    <p>Run <code>./sunbird-install.sh</code>. This will deploy the latest version of sunbird services and also update the latest schema on databases.</p>
  </li>
</ol>

<p><strong>Note:</strong> Latest images versions of all the services are updated in the master branch. To get the particular hotfix image of any Sunbird service, update the minor version in the <code>sunbird-devops/deploy/deploy-core.sh</code> file. Re-run the <code>sunbird-devops/deploy/deploy-core.sh</code></p>

<h2 id="backup-and-restore-of-sunbird-databases">Backup and Restore of Sunbird Databases</h2>

<ol>
  <li>
    <p>ssh to the database server on which you want to take backup.</p>
  </li>
  <li>
    <p>Run <code>git clone https://github.com/project-sunbird/sunbird-devops</code></p>
  </li>
  <li>
    <p>cd <code>sunbird-devops/deploy/</code></p>
  </li>
</ol>

<h3 id="cassandra">Cassandra</h3>

<p><strong>Backup:</strong></p>

<ul>
  <li>
    <p>Take a snapshot of Cassandara database using</p>

    <p>nodetool snapshot -t my_backup</p>
  </li>
  <li>
    <p>Copy the snapshot to your backup directory.</p>

    <pre><code>./cassandra_backup.py &lt;cassandra_data_path&gt; &lt;snapshot_name&gt; &lt;path_to_backup_directory&gt;
</code></pre>

    <p>for example:</p>

    <pre><code>./cassandra_backup.py  /var/lib/cassandra/data my_backup  cassandra_backup_20180412
</code></pre>
  </li>
  <li>
    <p>Above command creates the snapshot of all the keyspaces mentioned below.</p>

    <pre><code> portal         -  Stores the session data
 dialcodes      -  Stores the energized text book details
 sunbirdplugin  -  Stores the custom or plugin data(used by announcment team as an object api internally)
 sunbird	       -  Stores the org,user,course,batch,badgr etc..
</code></pre>
  </li>
</ul>

<p><strong>Restore:</strong></p>

<ul>
  <li>
    <p>Copy the Cassandra backup snapshot to the instance where you want to run restore.</p>
  </li>
  <li>
    <p>Restore Cassandra database using command</p>

    <pre><code>./cassandra_restore.py &lt;cassandra_host_ip_address&gt; &lt;snapshotdir&gt;
</code></pre>

    <p>for example:</p>

    <pre><code>./cassandra_restore.py 10.10.10.10 ./cassandra_bakup_20180412
</code></pre>
  </li>
</ul>

<h3 id="postgres">Postgres</h3>

<p><strong>Backup:</strong></p>

<ul>
  <li>
    <p>Run the script below to take a full backup of the Postgres database.</p>

    <pre><code>  ./backup_postgres.sh
</code></pre>
  </li>
  <li>
    <p>Above command creates the backup file in the location <code>/tmp/postgresql-backup</code>.</p>
  </li>
  <li>
    <p>Backup of Postgres is done for below databases</p>

    <pre><code>  api_manager -	Used by kong
  badger	    -	Used by badger services
  Keycloak    -	Used by Keycloak
  quartz      -	Used by sunbird backend services
</code></pre>
  </li>
</ul>

<p><strong>Restore:</strong></p>

<ul>
  <li>
    <p>Copy the backup file from the <code>/tmp/postgresql-backup/&lt;backup_file&gt;</code></p>
  </li>
  <li>
    <p>Run the below command for restore</p>

    <pre><code>  ./restore_postgres.sh
</code></pre>
  </li>
</ul>

<h3 id="elasticsearch">Elasticsearch</h3>

<p><strong>Backup:</strong></p>

<ul>
  <li>
    <p>Run the below script for backup</p>

    <pre><code>  ./backup_elasticsearch.sh
</code></pre>
  </li>
  <li>
    <p>Above command creates the backup file in the location <code>/etc/elasticsearch/backup</code>.</p>
  </li>
  <li>
    <p>Backup of Elasticsearch is done for below databases</p>

    <pre><code>  searchindex      - Stores the user, org , course, batch data
  sunbirdplugin    - Stores the plugin related data (object API)
  sunbirddataaudit - Stores the user &amp; org audit history data.
</code></pre>
  </li>
</ul>

<p><strong>Restore:</strong></p>

<p>Copy the backup file from the <code>/tmp/elasticsearch-backup/&lt;backup_file&gt;</code> to the instance where you want to run restore.</p>

<p>Run</p>

<pre><code>./restore_elasticsearch.sh &lt;path/to/the/restore_file	
</code></pre>

<p><strong>Note:</strong> Install Python on the Cassandra machine, if you use our scripts to backup or restore the Cassandra database.</p>

