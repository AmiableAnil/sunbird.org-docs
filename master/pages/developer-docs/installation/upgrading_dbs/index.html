<h2 id="overview">Overview</h2>

<p>Using an obsolete version of a database comes with disadvantages like missed opportunities for enhanced features, lack of technical support, incompatibility with software and hardware, and many others. Upgrading your database periodically, therefore is a necessity.    While upgrading, a careful review of the upgrade instructions will make a difference. By understanding what to do beforehand, you can ensure a smooth upgrade and avoid pitfalls and frustrations.
Read and understand the instructions on this page to plan and execute the upgrade of your Apache Cassandra database.</p>

<h2 id="upgrading-your-cassandra-installation">Upgrading your Cassandra installation</h2>

<p>To upgrade your Cassandra installation, abide by the following sequence:</p>

<ol>
  <li>Check upgrade scenarios</li>
  <li>Execute the build</li>
  <li>Deploy the build</li>
</ol>

<h2 id="check-upgrade-scenarios">Check Upgrade Scenarios</h2>

<p>Sunbird offers the Cassandra upgrade option from version 1.4.</p>

<ul>
  <li>
    <p>If you are on a Sunbird release version lower than version 1.4, ensure that your schemas and tables are not below Sunbird version 1.3</p>
  </li>
  <li>
    <p>Start your upgrade process with information about the version of the Sunbird you are currently running</p>
  </li>
  <li>
    <p>Before you run the upgrade script, check if the release version is lower than, greater than or equal to version 1.4</p>
  </li>
</ul>

<h3 id="running-a-release-version-lower-than-14">Running a release version lower than 1.4</h3>

<p>If you are running a version lesser than 1.4, execute the following command:</p>

<ul>
  <li>Run <strong>cassandra.cql</strong> file</li>
</ul>

<p>This command creates the schema and tables until release-1.3, ensuring that your schemas and tables fall in line with upgrade requirements.</p>

<p><strong>Note:</strong> Ignore any errors encountered while executing the command. The errors are fixed in later releases.</p>

<h3 id="running-a-release-version-greater-than-or-equal-to-release-14">Running a release version greater than or equal to release 1.4</h3>

<p>If you are on Sunbird release 1.4 or greater, the schemas and tables meet upgrade requirements. Proceed to the next steps of the upgrade process.</p>

<h2 id="build">Build</h2>

<ul>
  <li>Create a <strong>Cassandra_Build</strong> Jenkins job.</li>
  <li>Navigate to <strong>sunbird-utils/cassandra-migration</strong> directory and run <code>mvn clean install -DskipTests</code></li>
  <li>The <strong>cassandra-migration-0.0.1-SNAPSHOT-jar-with-dependencies.jar</strong> is created within the <strong>sunbird-utils/cassandra-migration/target</strong>   directory.</li>
</ul>

<h2 id="deploy">Deploy</h2>

<ul>
  <li>Create a <strong>Cassandra_Deploy</strong> Jenkins job</li>
  <li>Copy the artifact <strong>cassandra-migration-0.0.1-SNAPSHOT-jar-with-dependencies.jar</strong> from <strong>Cassandra_Build</strong> to <strong>Cassandra_Deploy</strong>
Jenkins job</li>
  <li>Copy the .jar file to the remote Cassandra machine.</li>
  <li>
    <p>Set the following enivronment variables on the Cassandra host:</p>

    <p>a. <strong>sunbird_cassandra_host:</strong> In case of multiple hosts, provide each value separated by a comma<br />
 b. <strong>sunbird_cassandra_port:</strong> 
 c. <strong>sunbird_cassandra_username:</strong> Optional 
 d. <strong>sunbird_cassandra_password:</strong> Optional 
 e. <strong>sunbird_cassandra_keyspace:</strong> for example: sunbird</p>
  </li>
  <li>
    <p>Ensure that the Cassandra keyspace is created. If not, execute the following command:</p>

    <p><code>CREATE KEYSPACE IF NOT EXISTS sunbird WITH replication = {'class':'SimpleStrategy','replication_factor':1};</code></p>
  </li>
  <li>While you ensure the availability of keyspaces, proceed to run the following command on your remote cassandra machine:</li>
</ul>

<p><code>Run java -cp "cassandra-migration-0.0.1-SNAPSHOT-jar-with-dependencies.jar com.contrastsecurity.cassandra.migration.utils.MigrationScriptEntryPoint</code></p>

<p>Add any new database change as a file to the following location in your codebase:</p>

<ul>
  <li><strong>resources/db/migration/cassandra</strong></li>
  <li>The inclusion criteria of files is based on the file naming convention.</li>
  <li>The files should essentially follow this convention.</li>
  <li><strong>V{major_version_no}.{minor_version_no}_{filename}.cql</strong></li>
</ul>

<p><strong>For example:</strong></p>

<ul>
  <li>V1.0_cassandra.cql    -  correct file format</li>
  <li>V1.0.1_cassandra.cql  - incorrect file format</li>
</ul>

<p>In case a file fails to execute, the script will not execute further until you fix the issue. After fixing the file, delete the corresponding wrong entry within the cassandra_migration_version table. This table is auto-generated during the upgrade process.</p>

<p><strong>Sample table structure</strong></p>

<ul>
  <li>version text (PRIMARY KEY)</li>
  <li>checksum (int)</li>
  <li>description (text)</li>
  <li>execution_time (int)</li>
  <li>installed_by (text)</li>
  <li>installed_on (timestamp)</li>
  <li>installed_rank (int)</li>
  <li>script (text)</li>
  <li>success (boolean)</li>
  <li>type (text)</li>
  <li>version_rank (int)</li>
</ul>

